<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Node</title>
    <script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
    <link href="style.css" rel="stylesheet" type="text/css"/>

</head>
<body>

<form action="http://localhost:8000" id="roomSelector" method="post">
    <input type="radio" name="room" value="0"> Room 0 <br>
    <input type="radio" name="room" value="1"> Room 1 <br>
    <input type="radio" name="room" value="2"> Room 2 <br>
    <input type="submit" value="Join room">
</form>


<section>
    <canvas id="myCanvas"></canvas>
</section>

<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
<script src="player.js"></script>
<script src="projectile.js"></script>
<script>
    var socket = io.connect("http://localhost:8000");

    var game = {};
    var room;
    var width = $("#myCanvas").css("width").split("p");
    var canvas = document.getElementById("myCanvas");
    canvas.width = width[0];
    canvas.height = width[0];

    var playerheight = width[0] / 10;
    var y = (width[0] / 2) - (playerheight / 2);
    var ball = new Projectile(10, {"dx": 3, "dy": 2}, {"x": 100, "y": 100});

    var player = new Player({"x": 10, "y": y}, {"width": 10, "height": playerheight}, "#FF0000", 20);

    $("#roomSelector").submit(function (e) {
        e.preventDefault();
        var url = $(this).attr("action"),
                method = $(this).attr("method"),
                selected = this.querySelector("input[name='room']:checked");

        $.ajax({
            url: url,
            type: method,
            data: "room=" + selected.value,
            success: function (data) {
                room = selected.value;
                init();
            }
        });
    });

    function init() {
//        console.log(room);
        socket.emit("newplayer", room);
    }


    if (socket !== undefined) {

        socket.on("servernewplayer", function (data) {
//            console.log(data);
            if (data.game === null) {
                // This means that we have to create a new game
                game.projectile = ball;
                player.id = data.id;
                game.player1 = player;
            } else {
                console.log(data);
                if (data.id !== player.id) {
                    console.log("New player...");
                    game.player1 = Player.revive(data.game.game.player1);
                    player.id = data.id;
                    game.player2 = player;
                    player.position.x = canvas.width - player.size.width;
                    ball = Projectile.revive(data.game.game.projectile);
                    game.projectile = ball;
                }

            }

            socket.emit("clientmessage", {"roomNumber": room, "game": game});

            requestAnimationFrame(mainLoop);
        });

        socket.on("servermessage", function (data) {
            if (data.roomNumber === room) {
                game.player2 = Player.revive(data.game.player2);
            }
        });

        socket.on("updatemessage", function (data) {
//        console.log("Received update message");
            if (data.game.roomNumber === room) {
//                console.log(data);
                if(game.player1 !== undefined && game.player2 !== undefined) {
                    if(data.game.game.player1.id !== player.id) {
                        game.player1.position = data.game.game.player1.position;
                    } else {
                        game.player2.position = data.game.game.player2.position;
                    }
                }
            }
        });

        socket.on("ballupdatemessage", function (data) {
            // Check if the difference is greater than 2, as to not create unnecessary updates.
            if (data.roomNumber === room) {
//                console.log(data);
                if (ball.position.x - data.projectile.position.x >= 2 &&
                        ball.position.y - data.projectile.position.y >= 2)
                    ball.position = data.projectile.position;
            }
//        game.projectile.position
        });

        socket.on("playerdisconnectmessage", function (data) {
            for (var o in game)
                if (game[o].id === data.id)
                    game[o] = null;
        });
    }

    function mainLoop() {
        var ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        player.update();

        if ((game.player1 !== null && game.player1 !== undefined) &&
                (game.player2 !== null && game.player2 !== undefined)) {
            ball.move(canvas, [game.player1, game.player2]);
        }

        if (game.player1 !== null && game.player1 !== undefined)
            game.player1.draw(ctx);

        if (game.player2 !== null && game.player2 !== undefined)
            game.player2.draw(ctx);

        if (game.projectile !== null && game.projectile !== undefined)
            game.projectile.draw(ctx);

        socket.emit("ballupdate", {"roomNumber": room, "projectile": game.projectile});
        socket.emit("clientupdate", {"roomNumber": room, "player": player});

        requestAnimationFrame(mainLoop);
    }


    $(window).on('beforeunload', function () {
        for (var o in game) {
            if (o.id === player.id) {
                o = null;
            }
        }
        if (socket !== undefined) {
            socket.emit("disconnecting", player);
            socket.close();
        }
    });


    //    $('#myButton').click(function () {
    //        var message = $('#msg').val();
    //        console.log(message);
    //        socket.emit("clientmessage", game);
    //    });


</script>
</body>
</html>